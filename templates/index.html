<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Unified AI-Assisted Screening Dashboard - Diabetic Retinopathy Detection</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="background-pattern"></div>
  <div class="container">
    <div class="header-section">
      <div class="header-icon">
        <i class="fas fa-eye"></i>
      </div>
      <h1>AI-Assisted Diabetic Retinopathy Screening</h1>
      <p class="subtitle">Advanced MobileNetV3 + Grad-CAM Technology</p>
    </div>

    <div class="upload-section">
      <form method="POST" enctype="multipart/form-data" id="uploadForm">
        <div class="upload-box">
          <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <h3>Upload Retinal Images</h3>
          <p>Select multiple images for batch analysis</p>
          <input type="file" name="images[]" accept="image/*" multiple id="fileInput">
          <label for="fileInput" class="file-label">
            <i class="fas fa-images"></i>
            Choose Images
          </label>
          <div class="file-info" id="fileInfo"></div>
          <button type="submit" class="analyze-btn">
            <i class="fas fa-search"></i>
            Analyze & Diagnose
          </button>
        </div>
      </form>
    </div>

    <div id="loading" class="loading">
      <div class="loader-spinner"></div>
      <div class="loading-text">
        <h3>Analyzing Images...</h3>
        <p>AI is processing your retinal images</p>
      </div>
    </div>

    {% if results %}
      <div class="results-section">
        <div class="results-header">
          <h2><i class="fas fa-chart-line"></i> Diagnostic Results</h2>
          <a href="{{ url_for('clear_results') }}" class="clear-button">
            <i class="fas fa-trash"></i>
            Clear Results
          </a>
        </div>
        
        <div class="table-container">
          <table class="results-table">
            <thead>
              <tr>
                <th><i class="fas fa-image"></i> Original Image</th>
                <th><i class="fas fa-diagnoses"></i> Diagnosis</th>
                <th><i class="fas fa-percentage"></i> Confidence</th>
                <th><i class="fas fa-fire"></i> Stage 1 Grad-CAM</th>
                <th><i class="fas fa-fire"></i> Stage 2 Grad-CAM</th>
              </tr>
            </thead>
            <tbody>
              {% for res in results %}
              <tr class="result-row {% if res.severity_idx == 0 %}severity-none{% elif res.severity_idx <= 2 %}severity-mild{% else %}severity-severe{% endif %}">
                <td>
                  <div class="image-container">
                    <img src="{{ url_for('static', filename='uploads/' + res.image_path) }}" class="result-image clickable" alt="Original Image">
                    <div class="image-overlay">
                      <i class="fas fa-expand"></i>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="diagnosis-info">
                    <span class="diagnosis-text">{{ res.prediction }}</span>
                    <div class="severity-indicator">
                      {% if res.severity_idx == 0 %}
                        <span class="severity-badge severity-none">No DR</span>
                      {% elif res.severity_idx <= 2 %}
                        <span class="severity-badge severity-mild">Mild-Moderate</span>
                      {% else %}
                        <span class="severity-badge severity-severe">Severe</span>
                      {% endif %}
                    </div>
                  </div>
                </td>
                <td>
                  <div class="confidence-container">
                    <div class="confidence-value">{{ res.confidence_percent }}%</div>
                    <div class="confidence-bar">
                      <div class="confidence-fill" style="width: {{ res.confidence_percent }}%"></div>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="image-container">
                    <img src="{{ url_for('static', filename='uploads/' + res.heatmap1) }}" class="result-image clickable" alt="Stage 1 Grad-CAM">
                    <div class="image-overlay">
                      <i class="fas fa-expand"></i>
                    </div>
                  </div>
                </td>
                <td>
                  {% if res.heatmap2 %}
                  <div class="image-container">
                    <img src="{{ url_for('static', filename='uploads/' + res.heatmap2) }}" class="result-image clickable" alt="Stage 2 Grad-CAM">
                    <div class="image-overlay">
                      <i class="fas fa-expand"></i>
                    </div>
                  </div>
                  {% else %}
                  <div class="not-available">
                    <i class="fas fa-minus-circle"></i>
                    <span>N/A</span>
                  </div>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="export-section">
          <h3><i class="fas fa-download"></i> Export Reports</h3>
          <div class="export-options">
            <a href="{{ url_for('export_csv') }}" class="export-btn csv-btn">
              <i class="fas fa-file-csv"></i>
              <span>Export CSV</span>
            </a>
            <a href="{{ url_for('export_pdf') }}" class="export-btn pdf-btn">
              <i class="fas fa-file-pdf"></i>
              <span>Export PDF</span>
            </a>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Modal for larger image -->
  <div id="modal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImg">
    <div class="modal-caption" id="modalCaption"></div>
  </div>

  <script>
    // File input handler
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const fileInfo = document.getElementById('fileInfo');
      const files = e.target.files;
      
      if (files.length > 0) {
        fileInfo.style.display = 'block';
        fileInfo.innerHTML = `<i class="fas fa-check-circle"></i> ${files.length} file(s) selected`;
      } else {
        fileInfo.style.display = 'none';
      }
    });

    // Loader
    document.getElementById('uploadForm').addEventListener('submit', function() {
      console.log('Form submitted, showing loader');
      document.getElementById('loading').style.display = 'flex';
    });

    // Modal for images
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const modalCaption = document.getElementById('modalCaption');
    const closeBtn = document.getElementsByClassName('close')[0];
    const imgs = document.querySelectorAll('.result-image.clickable');

    console.log('Found clickable images:', imgs.length);

    imgs.forEach(function(img, index) {
      img.addEventListener('click', function() {
        console.log('Image clicked:', index, this.src);
        modal.style.display = 'block';
        modalImg.src = this.src;
        modalCaption.textContent = this.alt || 'Medical Image';
      });
    });

    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        console.log('Close button clicked');
        modal.style.display = 'none';
      });
    } else {
      console.error('Close button not found');
    }

    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        console.log('Clicked outside modal');
        modal.style.display = 'none';
      }
    });

    // Add smooth scrolling to results
    if (document.querySelector('.results-section')) {
      console.log('Scrolling to results section');
      document.querySelector('.results-section').scrollIntoView({
        behavior: 'smooth'
      });
    }
  </script>
</body>
</html>